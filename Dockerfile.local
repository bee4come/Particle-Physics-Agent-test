# Local Development Dockerfile for FeynmanCraft ADK
# Optimized for fast local testing with LaTeX support

FROM python:3.11-slim

# Build argument for API key
ARG GOOGLE_API_KEY
ENV GOOGLE_API_KEY=${GOOGLE_API_KEY}

# Proxy settings (configured via build args)

# Set working directory
WORKDIR /app

# Install system dependencies and LaTeX environment
RUN apt-get update && apt-get install -y \
    # Build tools
    build-essential \
    gcc \
    g++ \
    git \
    curl \
    wget \
    # LaTeX and TikZ-Feynman dependencies
    texlive-latex-base \
    texlive-latex-extra \
    texlive-pictures \
    texlive-science \
    texlive-luatex \
    texlive-fonts-recommended \
    # Conversion tools for multi-format output
    pdf2svg \
    poppler-utils \
    ghostscript \
    # Cleanup
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Configure ImageMagick security policy for PDF processing
RUN sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml

# Verify LaTeX installation
RUN lualatex --version && \
    pdflatex --version && \
    pdf2svg --version && \
    pdftoppm -h

# Copy requirements first for better caching
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Copy the agent code
COPY feynmancraft_adk/ ./feynmancraft_adk/

# Set environment variables for local development
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV PORT=8000
ENV HOST=0.0.0.0

# Local development specific settings
ENV FEYNMANCRAFT_ADK_LOG_LEVEL=DEBUG
ENV KB_MODE=local
ENV DEFAULT_SEARCH_K=5

# LaTeX compilation settings
ENV LATEX_COMPILE_ENGINE=lualatex
ENV LATEX_COMPILE_TIMEOUT=30
ENV LATEX_OUTPUT_FORMATS=pdf,svg,png

# Create directories for LaTeX compilation
RUN mkdir -p /tmp/latex_compiler && \
    chmod 755 /tmp/latex_compiler

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Run the ADK server
CMD ["sh", "-c", "adk web --port=${PORT} --host=${HOST} /app"]